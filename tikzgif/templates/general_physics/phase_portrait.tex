%%--- TIKZGIF META ---
%% name: physics.phase_portrait
%% title: Phase Portrait Animation
%% description: >
%%   Phase portrait of dx/dt = [[-a, b],[-b, -a]]*x.
%%   Sweeping a shows stable spiral -> center -> unstable spiral.
%% author: J.C. Vaught
%% version: 1.0.0
%% domain: general_physics
%% tags: [phase portrait, ODE, dynamical system, spiral]
%% engine: pdflatex
%% tikz_libraries: [arrows.meta]
%% latex_packages: [tikz, amsmath]
%% params:
%%   - name: a
%%     type: float
%%     default: 0.5
%%     min: -1.0
%%     max: 2.0
%%     step: 0.1
%%     sweep: true
%%     description: Real part of eigenvalue (damping)
%%     unit: ""
%%   - name: b
%%     type: float
%%     default: 2.0
%%     min: 0.5
%%     max: 5.0
%%     sweep: false
%%     description: Imaginary part of eigenvalue (rotation)
%%     unit: ""
%% fps: 10
%% frames: 31
%% loop: true
%% bounce: true
%%--- END META ---
\documentclass[border=8pt,tikz]{standalone}
\usepackage{tikz}
\usepackage{amsmath}
\usetikzlibrary{arrows.meta}

\begin{document}
\begin{tikzpicture}[>=Stealth]

\pgfmathsetmacro{\aval}{{{{ a }}}}
\pgfmathsetmacro{\bval}{{{{ b }}}}

% Axes
\draw[->, thick, black!60] (-4.2, 0) -- (4.2, 0) node[right, font=\small]{$x_1$};
\draw[->, thick, black!60] (0, -4.2) -- (0, 4.2) node[above, font=\small]{$x_2$};

% Grid
\foreach \v in {-4,-3,-2,-1,1,2,3,4} {
    \draw[gray!15, thin] (\v, -4) -- (\v, 4);
    \draw[gray!15, thin] (-4, \v) -- (4, \v);
}

% Vector field
\foreach \xi in {-3.5, -2.5, -1.5, -0.5, 0.5, 1.5, 2.5, 3.5} {
    \foreach \yi in {-3.5, -2.5, -1.5, -0.5, 0.5, 1.5, 2.5, 3.5} {
        \pgfmathsetmacro{\dx}{-\aval*\xi + \bval*\yi}
        \pgfmathsetmacro{\dy}{-\bval*\xi - \aval*\yi}
        \pgfmathsetmacro{\mag}{sqrt(\dx*\dx + \dy*\dy)}
        \pgfmathsetmacro{\scale}{min(0.35, 0.35*\mag/3)}
        \pgfmathparse{\mag > 0.1 ? 1 : 0}
        \ifnum\pgfmathresult=1
            \pgfmathsetmacro{\ndx}{\dx/\mag*\scale}
            \pgfmathsetmacro{\ndy}{\dy/\mag*\scale}
            \draw[->, gray!50, thin] (\xi, \yi) -- ({\xi+\ndx}, {\yi+\ndy});
        \fi
    }
}

% Trajectories: x(t) = e^{-a*t} * R0 * [cos(b*t + th), sin(b*t + th)]
\foreach \thetaStart in {0, 60, 120, 180, 240, 300} {
    \pgfmathsetmacro{\R}{3.0}
    \draw[blue!70!black, thick, samples=120, domain=0:6.28, variable=\t]
        plot ({exp(-\aval*\t) * \R * cos(\bval*\t*180/3.14159 + \thetaStart)},
              {exp(-\aval*\t) * \R * sin(\bval*\t*180/3.14159 + \thetaStart)});
    \filldraw[red!70!black]
        ({\R * cos(\thetaStart)}, {\R * sin(\thetaStart)}) circle (2pt);
}

\filldraw[black] (0, 0) circle (3pt);

% Stability label
\pgfmathparse{\aval > 0.05 ? 1 : (\aval < -0.05 ? -1 : 0)}
\pgfmathtruncatemacro{\stabType}{\pgfmathresult}

\ifnum\stabType=1
    \node[anchor=north east, font=\footnotesize, fill=green!10, inner sep=3pt,
          draw=green!40!black]
        at (4.0, 4.0) {Stable spiral ($a = \pgfmathprintnumber[fixed,precision=2]{\aval}$)};
\fi
\ifnum\stabType=-1
    \node[anchor=north east, font=\footnotesize, fill=red!10, inner sep=3pt,
          draw=red!40!black]
        at (4.0, 4.0) {Unstable spiral ($a = \pgfmathprintnumber[fixed,precision=2]{\aval}$)};
\fi
\ifnum\stabType=0
    \node[anchor=north east, font=\footnotesize, fill=yellow!10, inner sep=3pt,
          draw=yellow!60!black]
        at (4.0, 4.0) {Center ($a \approx 0$)};
\fi

\node[anchor=south west, font=\footnotesize, fill=white, inner sep=3pt]
    at (-4.0, -4.0)
    {$\dot{\mathbf{x}} = \begin{bmatrix} -a & b \\ -b & -a \end{bmatrix} \mathbf{x}$};

\end{tikzpicture}
\end{document}
