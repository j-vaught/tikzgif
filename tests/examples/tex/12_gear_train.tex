% Example 12: Gear Train
% Two meshing gears rotating in opposite directions.
% Parameter: \PARAM (rotation angle of gear 1 in degrees, 0 to 360)
% Range: 0 to 360, recommended 72 frames (5-degree steps)
% Difficulty: intermediate
% Features demonstrated: parameterized drawing, mechanical simulation, rotation
\documentclass[tikz]{standalone}
\usepackage{tikz}
\usepackage{xcolor}

% USC Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}
  \useasboundingbox (-6,-5.5) rectangle (7,5.5);

  \pgfmathsetmacro{\angleA}{\PARAM}

  % Gear parameters (module = tooth size)
  \pgfmathtruncatemacro{\teethA}{16}
  \pgfmathtruncatemacro{\teethB}{24}
  \pgfmathsetmacro{\moduleVal}{0.25}
  \pgfmathsetmacro{\pitchA}{\teethA * \moduleVal / 2}   % pitch radius A = 2.0
  \pgfmathsetmacro{\pitchB}{\teethB * \moduleVal / 2}   % pitch radius B = 3.0
  \pgfmathsetmacro{\addendum}{\moduleVal}                % 0.25
  \pgfmathsetmacro{\dedendum}{\moduleVal * 1.25}         % 0.3125
  \pgfmathsetmacro{\outerA}{\pitchA + \addendum}
  \pgfmathsetmacro{\rootA}{\pitchA - \dedendum}
  \pgfmathsetmacro{\outerB}{\pitchB + \addendum}
  \pgfmathsetmacro{\rootB}{\pitchB - \dedendum}

  % Gear B rotates opposite, scaled by gear ratio
  \pgfmathsetmacro{\angleB}{-\angleA * \teethA / \teethB}
  \pgfmathsetmacro{\meshOffset}{180 / \teethB}

  % Center positions (pitch circles tangent)
  \pgfmathsetmacro{\distAB}{\pitchA + \pitchB}
  \coordinate (cA) at ({-\distAB/2}, 0);
  \coordinate (cB) at ({\distAB/2}, 0);

  % === Draw gear macro ===
  % #1=center, #2=pitch R, #3=outer R, #4=root R, #5=teeth, #6=angle, #7=color
  \newcommand{\drawgear}[7]{%
    \begin{scope}[shift={#1}, rotate=#6]
      %% Gear body (root circle fill)
      \fill[#7!15] (0,0) circle (#4);

      %% Teeth: trapezoidal profile from root to tip
      \pgfmathsetmacro{\angpitch}{360 / #5}
      \foreach \t in {1,...,#5} {
        \pgfmathsetmacro{\tc}{\angpitch * \t}
        \pgfmathsetmacro{\hbase}{\angpitch * 0.25}
        \pgfmathsetmacro{\htip}{\angpitch * 0.18}
        \fill[#7!28]
          ({\tc - \hbase}:#4) -- ({\tc - \htip}:#3)
          -- ({\tc + \htip}:#3) -- ({\tc + \hbase}:#4) -- cycle;
        \draw[#7!70!black, line width=0.5pt]
          ({\tc - \hbase}:#4) -- ({\tc - \htip}:#3)
          -- ({\tc + \htip}:#3) -- ({\tc + \hbase}:#4);
      }

      %% Root circle outline
      \draw[#7!60!black, line width=0.6pt] (0,0) circle (#4);

      %% Pitch circle (dashed reference)
      \draw[#7!30, line width=0.3pt, dashed] (0,0) circle (#2);

      %% Inner web
      \pgfmathsetmacro{\webR}{#4 * 0.7}
      \fill[#7!10] (0,0) circle (\webR);
      \draw[#7!40, line width=0.4pt] (0,0) circle (\webR);

      %% Lightening holes
      \pgfmathsetmacro{\holeR}{#4 * 0.16}
      \pgfmathsetmacro{\holeDist}{#4 * 0.46}
      \foreach \h in {0,60,...,300} {
        \fill[white] (\h:\holeDist) circle (\holeR);
        \draw[#7!35, line width=0.4pt] (\h:\holeDist) circle (\holeR);
      }

      %% Hub
      \pgfmathsetmacro{\hubR}{#2 * 0.2}
      \fill[#7!30] (0,0) circle (\hubR);
      \draw[#7!60!black, line width=0.8pt] (0,0) circle (\hubR);

      %% Bore hole
      \pgfmathsetmacro{\boreR}{#2 * 0.09}
      \fill[white] (0,0) circle (\boreR);
      \draw[#7!60!black, line width=0.5pt] (0,0) circle (\boreR);

      %% Keyway slot (extends outward from bore into hub)
      \pgfmathsetmacro{\keyW}{#2 * 0.04}
      \pgfmathsetmacro{\keyOuter}{\hubR * 0.85}
      \fill[white] (-\keyW, \boreR) rectangle (\keyW, \keyOuter);
      \draw[#7!60!black, line width=0.4pt]
        (-\keyW, \boreR) -- (-\keyW, \keyOuter) -- (\keyW, \keyOuter) -- (\keyW, \boreR);
    \end{scope}
  }%

  % Draw gear B first (behind), then A on top at mesh point
  \drawgear{(cB)}{\pitchB}{\outerB}{\rootB}{\teethB}{\angleB + \meshOffset}{atlantic}
  \drawgear{(cA)}{\pitchA}{\outerA}{\rootA}{\teethA}{\angleA}{garnet}

  % Rotation arrows (A = CCW, B = CW)
  \draw[->, garnet, thick]
    ([shift={(50:{\outerA + 0.35})}]cA) arc (50:130:{\outerA + 0.35});
  \draw[->, atlantic, thick]
    ([shift={(130:{\outerB + 0.35})}]cB) arc (130:50:{\outerB + 0.35});

  % Labels
  \node[below, font=\small\bfseries, garnet!80!black] at ([yshift={-\outerA cm - 0.5cm}]cA)
    {Gear A (\teethA\,T)};
  \node[below, font=\small\bfseries, atlantic!80!black] at ([yshift={-\outerB cm - 0.5cm}]cB)
    {Gear B (\teethB\,T)};

  % Angle readout
  \node[font=\small] at (0, -4.8)
    {$\theta_A = \pgfmathprintnumber[fixed, precision=0]{\angleA}^\circ$
     \quad
     $\theta_B = \pgfmathprintnumber[fixed, precision=0]{\angleB}^\circ$};
\end{tikzpicture}
\end{document}
