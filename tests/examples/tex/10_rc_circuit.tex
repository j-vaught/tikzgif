% Example 10: RC Circuit Charging
% An RC circuit diagram with the capacitor voltage rising exponentially,
% accompanied by a real-time plot.
% Parameter: \PARAM (normalized time t/tau, 0 to 5)
% Range: 0 to 5, recommended 50 frames
% Difficulty: intermediate
% Features demonstrated: circuit-like drawing, exponential curves, dual panels
\documentclass[tikz]{standalone}
\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.18}
\usetikzlibrary{decorations.markings}
\begin{document}
\begin{tikzpicture}
  \pgfmathsetmacro{\ttau}{max(\PARAM, 0.01)}  % t/tau (clamped to avoid zero domain)
  \pgfmathsetmacro{\Vs}{5}         % source voltage
  \pgfmathsetmacro{\Vc}{\Vs * (1 - exp(-\ttau))}  % capacitor voltage
  \pgfmathsetmacro{\Ic}{exp(-\ttau)}               % normalized current

  % --- Circuit Diagram (left panel) ---
  \begin{scope}[shift={(-5,0)}]
    % Battery
    \draw[thick] (0,0) -- (0,2);
    \draw[thick] (-0.3,2) -- (0.3,2);
    \draw[thick] (-0.15,2.3) -- (0.15,2.3);
    \node[left, font=\small] at (-0.3,2.15) {$V_s$};

    % Top wire with switch
    \draw[thick] (0,2.3) -- (0,3) -- (1,3);
    % Switch (closes based on time)
    \draw[thick] (1,3) -- (1.8,3);
    \fill (1,3) circle (2pt);
    \fill (1.8,3) circle (2pt);
    \node[above, font=\tiny] at (1.4,3.1) {$t=0$};

    % Resistor
    \draw[thick] (1.8,3) -- (2.2,3);
    \draw[thick] (2.2,3) -- (2.4,3.3) -- (2.6,2.7) -- (2.8,3.3) --
                 (3.0,2.7) -- (3.2,3.3) -- (3.4,2.7) -- (3.6,3);
    \draw[thick] (3.6,3) -- (4,3);
    \node[above, font=\small] at (2.9,3.4) {$R$};

    % Wire to capacitor
    \draw[thick] (4,3) -- (4,1.5);

    % Capacitor
    \draw[thick] (3.6,1.5) -- (4.4,1.5);
    \draw[thick] (3.6,1.1) -- (4.4,1.1);
    \node[right, font=\small] at (4.5,1.3) {$C$};

    % Capacitor voltage indicator (colored fill)
    \pgfmathsetmacro{\fillht}{0.4 * \Vc / \Vs}
    \fill[red!40, opacity=0.6] (3.65, 1.1) rectangle (4.35, {1.1 + \fillht});

    % Bottom wire
    \draw[thick] (4,1.1) -- (4,0) -- (0,0);

    % Current arrow
    \pgfmathsetmacro{\arrowsize}{max(0.1, \Ic * 0.4)}
    \pgfmathsetmacro{\linewd}{0.5 + \Ic * 2}
    \draw[->, red!70!black, line width=\linewd pt]
      (2.9, 3.6) -- (3.5, 3.6);
    \node[above, font=\tiny, red!70!black] at (3.2, 3.7) {$i(t)$};

    % Voltage label
    \node[below, font=\small] at (4, 0.9)
      {$V_C = \pgfmathprintnumber[fixed, precision=2]{\Vc}$ V};
  \end{scope}

  % --- Voltage Plot (right panel) ---
  \begin{axis}[
    at={(0cm,-2cm)},
    anchor=south west,
    width=7cm, height=5cm,
    domain=0:5,
    samples=100,
    axis lines=left,
    xlabel={$t/\tau$},
    ylabel={Voltage (V)},
    ymin=0, ymax=6,
    xmin=0, xmax=5,
    grid=major,
    grid style={gray!25},
    title={\small Capacitor Charging},
  ]
    % Full response curve (faint)
    \addplot[gray!40, thick] {\Vs * (1 - exp(-x))};

    % Traced portion up to current time
    \addplot[red!70!black, very thick, domain=0:\ttau] {\Vs * (1 - exp(-x))};

    % Current point
    \addplot[only marks, mark=*, mark size=3pt, red!70!black]
      coordinates {(\ttau, \Vc)};

    % Asymptote
    \addplot[dashed, blue!50, thin] {\Vs};
    \node[right, font=\tiny, blue!50] at (axis cs:4.2, 5.2) {$V_s$};

    % Time constant markers
    \addplot[dotted, black!30] coordinates {(1,0) (1,{\Vs*(1-exp(-1))})};
    \node[below, font=\tiny] at (axis cs:1, 0) {$\tau$};
  \end{axis}
\end{tikzpicture}
\end{document}
