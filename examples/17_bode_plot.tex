% Example 17: Base-Excited Mass-Spring-Damper with Bode Plot
% Vertical SMD with base excitation (left) and Bode magnitude + phase (right).
% Frequency ratio r = w/w_n sweeps to show resonance and vibration isolation.
% Parameter: \PARAM (frequency ratio r = w/w_n, range 0.2..3.0)
% Range: 0.2 to 3.0, recommended 60 frames at 15fps
% Difficulty: advanced
% Features demonstrated: mechanical diagrams, frequency response, resonance,
%   vibration isolation, Bode plots, pgfplots

\documentclass[tikz]{standalone}
\usepackage{pgfplots}
\usepackage{amsmath}
\pgfplotsset{compat=1.18}
\usetikzlibrary{decorations.pathmorphing, decorations.markings, calc}

% Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}

\useasboundingbox (-0.5, -5.5) rectangle (13.5, 5.5);

% ── Parameters ──
\pgfmathsetmacro{\rNow}{\PARAM}          % frequency ratio r = w/w_n
\pgfmathsetmacro{\zetaVal}{0.20}          % damping ratio
\pgfmathsetmacro{\Azero}{0.6}            % base excitation amplitude (cm)

% ── Transmissibility magnitude ──
\pgfmathsetmacro{\rSq}{\rNow*\rNow}
\pgfmathsetmacro{\twoZR}{2*\zetaVal*\rNow}
\pgfmathsetmacro{\num}{1 + \twoZR*\twoZR}
\pgfmathsetmacro{\den}{(1 - \rSq)*(1 - \rSq) + \twoZR*\twoZR}
\pgfmathsetmacro{\denSafe}{max(\den, 0.0001)}
\pgfmathsetmacro{\Tmag}{sqrt(\num / \denSafe)}
\pgfmathsetmacro{\TdBnow}{10 * ln(\num / \denSafe) / ln(10)}

% ── Transmissibility phase ──
\pgfmathsetmacro{\Hreal}{1 - \rSq + 4*\zetaVal*\zetaVal*\rSq}
\pgfmathsetmacro{\Himag}{-2*\zetaVal*\rNow*\rNow*\rNow}
\pgfmathsetmacro{\phaseNow}{%
  (\Hreal >= 0) ? atan(\Himag / max(\Hreal, 0.001)) : (atan(\Himag / \Hreal) - 180)}

% ── Animation phase (creates visible oscillation across frames) ──
\pgfmathsetmacro{\animPhase}{360 * 5 * (\rNow - 0.2) / 2.8}
\pgfmathsetmacro{\yBase}{\Azero * sin(\animPhase)}
\pgfmathsetmacro{\yMassRaw}{\Azero * \Tmag * sin(\animPhase + \phaseNow)}
\pgfmathsetmacro{\yMass}{max(min(\yMassRaw, 1.8), -1.8)}

% ── SMD Equilibrium positions ──
\pgfmathsetmacro{\baseEq}{-2.5}          % equilibrium base y
\pgfmathsetmacro{\massEq}{1.5}           % equilibrium mass y
\pgfmathsetmacro{\eqLen}{4.0}            % equilibrium spring/damper length

% ── Actual positions ──
\pgfmathsetmacro{\baseY}{\baseEq + \yBase}
\pgfmathsetmacro{\massY}{\massEq + \yMass}
\pgfmathsetmacro{\springLen}{\massY - \baseY}

% ════════════════════════════════════════════════════════════════
%  LEFT: Vertical Mass-Spring-Damper Diagram (x = 0..4, y = -4..4)
% ════════════════════════════════════════════════════════════════

% ── Base platform (moves vertically) ──
\draw[very thick, black!80] (-0.2, \baseY) -- (4.2, \baseY);
% Ground hatching below base
\foreach \xx in {0.0, 0.4, 0.8, 1.2, 1.6, 2.0, 2.4, 2.8, 3.2, 3.6, 4.0} {
  \draw[thin, warmgrey] (\xx, \baseY) -- ({\xx - 0.25}, {\baseY - 0.3});
}

% ── Spring (left side, x ~ 1.0) ──
\pgfmathsetmacro{\springBot}{\baseY + 0.15}
\pgfmathsetmacro{\springTop}{\massY - 0.4}
\pgfmathsetmacro{\springDrawLen}{\springTop - \springBot}
\pgfmathsetmacro{\segLen}{max(\springDrawLen/6*28.3465, 4)}
\draw[thick, black!70, decorate,
  decoration={zigzag, segment length=\segLen pt, amplitude=2.5pt}]
  (1.0, \springBot) -- (1.0, \springTop);

% ── Damper (right side, x ~ 3.0) ──
\pgfmathsetmacro{\damperBot}{\baseY + 0.15}
\pgfmathsetmacro{\damperTop}{\massY - 0.4}
\pgfmathsetmacro{\damperMid}{(\damperBot + \damperTop) / 2}
\pgfmathsetmacro{\cylH}{0.18}
\pgfmathsetmacro{\cylHalfW}{0.7}

% Rod from base to cylinder bottom
\draw[thick, black!70] (3.0, \damperBot) -- (3.0, {\damperMid - \cylHalfW});

% Cylinder body (open at top, closed at bottom)
\draw[thick, black!70]
  ({3.0 - \cylH}, {\damperMid - \cylHalfW}) -- ({3.0 + \cylH}, {\damperMid - \cylHalfW})
  ({3.0 - \cylH}, {\damperMid - \cylHalfW}) -- ({3.0 - \cylH}, {\damperMid + \cylHalfW})
  ({3.0 + \cylH}, {\damperMid - \cylHalfW}) -- ({3.0 + \cylH}, {\damperMid + \cylHalfW});

% Piston head inside cylinder
\pgfmathsetmacro{\pistonY}{\damperMid + (\yMass - \yBase) / \eqLen * \cylHalfW}
\draw[very thick, black!80]
  ({3.0 - \cylH + 0.02}, \pistonY) -- ({3.0 + \cylH - 0.02}, \pistonY);

% Piston rod from piston head to mass
\draw[thick, black!70] (3.0, \pistonY) -- (3.0, \damperTop);

% ── Mass block ──
\pgfmathsetmacro{\massLeft}{0.6}
\pgfmathsetmacro{\massRight}{3.4}
\pgfmathsetmacro{\massBot}{\massY - 0.4}
\pgfmathsetmacro{\massTop}{\massY + 0.4}
\fill[garnet, opacity=0.85]
  (\massLeft, \massBot) rectangle (\massRight, \massTop);
\draw[thick, black!80]
  (\massLeft, \massBot) rectangle (\massRight, \massTop);
\node[font=\bfseries\small, white] at (2.0, \massY) {$m$};

% ── Labels ──
\node[font=\scriptsize, black!60, left] at (0.65, {(\springBot + \springTop)/2}) {$k$};
\node[font=\scriptsize, black!60, right] at (3.35, {\damperMid}) {$c$};

% ── Base motion arrow ──
\pgfmathsetmacro{\arrowDir}{(\yBase >= 0) ? 1 : -1}
\pgfmathsetmacro{\absYBase}{abs(\yBase)}
\pgfmathparse{\absYBase > 0.05 ? 1 : 0}
\ifnum\pgfmathresult=1
  \draw[->, rose, thick] (-0.35, \baseY) -- (-0.35, {\baseY + 0.5*\arrowDir});
\fi
\node[font=\tiny, rose, anchor=west, align=center] at (0.0, {\baseEq - 0.85})
  {$Y_0\!\sin(\omega t)$};

% ── Mass motion arrow ──
\pgfmathsetmacro{\arrowDirM}{(\yMass >= 0) ? 1 : -1}
\pgfmathsetmacro{\absYMass}{abs(\yMass)}
\pgfmathparse{\absYMass > 0.05 ? 1 : 0}
\ifnum\pgfmathresult=1
  \draw[->, atlantic, thick] (3.65, \massY) -- (3.65, {\massY + 0.5*\arrowDirM});
\fi

% ── Title above SMD ──
\node[font=\bfseries\small, black] at (2.0, 4.3)
  {Base-Excited SMD};
\node[font=\scriptsize, warmgrey] at (2.0, 3.85)
  {$\zeta = 0.20$};

% ════════════════════════════════════════════════════════════════
%  RIGHT: Bode Magnitude Plot (top)
% ════════════════════════════════════════════════════════════════

\begin{axis}[
  name=mag,
  at={(5.5cm, 0.3cm)}, anchor=south west,
  width=8.5cm, height=5cm,
  xmode=log, xmin=0.1, xmax=5,
  ymin=-30, ymax=15,
  ylabel={$|T|$ (dB)},
  grid=both, grid style={warmgrey!15},
  thick,
  tick label style={font=\tiny},
  label style={font=\footnotesize},
  xticklabels={},
  xtick={0.1, 0.2, 0.5, 1, 2, 5},
  ytick={-30, -20, -10, 0, 10},
  clip=false,
]
  % 0 dB reference line
  \addplot[dashed, warmgrey, thin, domain=0.1:5, samples=2] {0};

  % Full transmissibility magnitude curve
  \addplot[domain=0.1:5, samples=400, atlantic, very thick]
    {10 * ln( max((1 + (2*\zetaVal*x)^2) / max((1 - x*x)^2 + (2*\zetaVal*x)^2, 0.0001), 0.0001) ) / ln(10)};

  % Tracking dot at current frequency ratio
  \addplot[only marks, mark=*, mark size=3pt, garnet]
    coordinates {(\rNow, \TdBnow)};

  % Resonance label near peak
  \node[font=\tiny, atlantic, anchor=south west] at (axis cs:1.15, 8.5)
    {Resonance};
  \draw[->, thin, atlantic] (axis cs:1.12, 8.3) -- (axis cs:1.03, 8.1);
\end{axis}

% Title above magnitude plot
\node[font=\small\bfseries, black, anchor=south] at (mag.north) {Transmissibility Bode Plot};

% ════════════════════════════════════════════════════════════════
%  RIGHT: Bode Phase Plot (bottom, stacked below magnitude)
% ════════════════════════════════════════════════════════════════

\begin{axis}[
  name=phase,
  at=(mag.below south west), anchor=north west,
  width=8.5cm, height=4.5cm,
  xmode=log, xmin=0.1, xmax=5,
  ymin=-180, ymax=10,
  xlabel={Frequency ratio $r = \omega/\omega_n$},
  ylabel={$\angle T$ (deg)},
  grid=both, grid style={warmgrey!15},
  thick,
  tick label style={font=\tiny},
  label style={font=\footnotesize},
  xtick={0.1, 0.2, 0.5, 1, 2, 5},
  xticklabels={0.1, 0.2, 0.5, 1, 2, 5},
  ytick={0, -45, -90, -135, -180},
  clip=false,
]
  % -90 deg reference line
  \addplot[dashed, warmgrey, thin, domain=0.1:5, samples=2] {-90};

  % Full transmissibility phase curve
  \addplot[domain=0.1:5, samples=400, garnet, very thick]
    {(1 - x*x + 4*\zetaVal*\zetaVal*x*x >= 0)
      ? atan((-2*\zetaVal*x*x*x) / max(1 - x*x + 4*\zetaVal*\zetaVal*x*x, 0.001))
      : (atan((-2*\zetaVal*x*x*x) / (1 - x*x + 4*\zetaVal*\zetaVal*x*x)) - 180)};

  % Tracking dot at current frequency ratio
  \addplot[only marks, mark=*, mark size=3pt, atlantic]
    coordinates {(\rNow, \phaseNow)};
\end{axis}

% ════════════════════════════════════════════════════════════════
%  INFO READOUT
% ════════════════════════════════════════════════════════════════

\node[font=\footnotesize, warmgrey, anchor=north] at (6.5, -5.0)
  {$r = \omega/\omega_n = \pgfmathprintnumber[fixed, precision=2, fixed zerofill]{\rNow}$
   \qquad
   $\zeta = 0.20$
   \qquad
   $|T| = \pgfmathprintnumber[fixed, precision=1, fixed zerofill]{\TdBnow}$ dB};

\end{tikzpicture}
\end{document}
