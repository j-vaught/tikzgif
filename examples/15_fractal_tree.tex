% Example 15: Fractal Tree Growth
% A recursive tree that grows branch by branch over time.
% Parameter: \PARAM (growth progress, 0 to 1)
% Range: 0 to 1, recommended 60 frames
% Difficulty: advanced
% Features demonstrated: recursive macros, conditional drawing, organic shapes
\documentclass[tikz]{standalone}
\usepackage{tikz}
\usepackage{xcolor}

% USC Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}
  \useasboundingbox (-5,-1.5) rectangle (5,8.5);

  \pgfmathsetseed{42}
  \pgfmathsetmacro{\progress}{\PARAM}

  \pgfmathtruncatemacro{\maxdepth}{8}
  \pgfmathsetmacro{\currentdepth}{\progress * \maxdepth}

  % Recursive branch command
  % #1=startX, #2=startY, #3=angle, #4=length, #5=depth, #6=thickness
  \newcommand{\branch}[6]{%
    \pgfmathtruncatemacro{\dep}{#5}%
    %
    % BASE CASE: terminal leaf node
    \ifnum\dep=\maxdepth
      % Consume 3 rnd values for deterministic RNG sequence
      \pgfmathsetmacro{\leafsz}{0.06 + 0.03 * rnd}%
      \pgfmathsetmacro{\leafclr}{40 + 30 * rnd}%
      \pgfmathsetmacro{\leafopa}{0.6 + 0.3 * rnd}%
      % Draw leaf if parent depth is visible
      \pgfmathsetmacro{\parentvis}{(\dep - 1) < \currentdepth ? 1 : 0}%
      \ifdim\parentvis pt>0.5pt
        \pgfmathsetmacro{\parentgrow}{min(1, \currentdepth - (\dep - 1))}%
        \pgfmathsetmacro{\finalopa}{\leafopa * \parentgrow}%
        \fill[horseshoe!\leafclr!grass, opacity=\finalopa] (#1, #2) circle (\leafsz);%
      \fi
    \else
      % Check if this depth is visible yet
      \pgfmathsetmacro{\branchvisible}{\dep < \currentdepth ? 1 : 0}%
      \ifdim\branchvisible pt>0.5pt
        % Consume 2 rand values for jitter
        \pgfmathsetmacro{\angleJitter}{5 * rand}%
        \pgfmathsetmacro{\lenJitter}{1 + 0.15 * rand}%
        %
        \pgfmathsetmacro{\growfactor}{min(1, \currentdepth - \dep)}%
        \pgfmathsetmacro{\adjlen}{#4 * \lenJitter}%
        \pgfmathsetmacro{\ix}{#1 + \growfactor * \adjlen * sin(#3 + \angleJitter)}%
        \pgfmathsetmacro{\iy}{#2 + \growfactor * \adjlen * cos(#3 + \angleJitter)}%
        %
        % Color: gradual transition from brown trunk to green tips
        \pgfmathtruncatemacro{\greenpct}{min(100, max(0, \dep * 15))}%
        \draw[line width=#6 pt, line cap=round, horseshoe!\greenpct!warmgrey!80!black]
          (#1, #2) -- (\ix, \iy);%
        %
        % Recurse into children only when fully grown
        \ifdim\growfactor pt>0.99pt
          \pgfmathsetmacro{\ex}{#1 + \adjlen * sin(#3 + \angleJitter)}%
          \pgfmathsetmacro{\ey}{#2 + \adjlen * cos(#3 + \angleJitter)}%
          \pgfmathsetmacro{\newlen}{#4 * 0.68}%
          \pgfmathsetmacro{\newthick}{max(0.15, #6 * 0.62)}%
          \pgfmathtruncatemacro{\newdep}{\dep + 1}%
          \pgfmathsetmacro{\splay}{22 - \dep * 0.5}%
          %
          \pgfmathsetmacro{\angleL}{#3 + \angleJitter - \splay}%
          \pgfmathsetmacro{\angleR}{#3 + \angleJitter + \splay}%
          \begingroup
            \branch{\ex}{\ey}{\angleL}{\newlen}{\newdep}{\newthick}%
          \endgroup
          \begingroup
            \branch{\ex}{\ey}{\angleR}{\newlen}{\newdep}{\newthick}%
          \endgroup
        \fi
      \fi
    \fi
  }

  % Ground
  \fill[horseshoe!30!warmgrey!20] (-5, -0.3) rectangle (5, 0);
  \draw[warmgrey, thick] (-5, 0) -- (5, 0);

  % Trunk
  \pgfmathsetmacro{\trunktop}{1.1}
  \draw[line width=8pt, line cap=round, warmgrey!60!black] (0, 0) -- (0, \trunktop);

  % Three main limbs for a full crown
  % Center limb (tallest, fills the gap between side limbs)
  \branch{0}{\trunktop}{0}{1.6}{0}{4.0}
  % Left limb (starts at depth 1 so it's shorter)
  \branch{0}{\trunktop}{-24}{1.2}{1}{2.8}
  % Right limb
  \branch{0}{\trunktop}{24}{1.2}{1}{2.8}

  % Label
  \node[below, font=\small] at (0, -0.8)
    {Growth: $\pgfmathparse{\progress * 100}\pgfmathprintnumber[fixed, precision=0]{\pgfmathresult}\%$};
\end{tikzpicture}
\end{document}
