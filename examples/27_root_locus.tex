% Example 27: Root Locus Animation
% Animates poles of 1 + K*G(s) = 0 where G(s) = 1/((s+1)(s+3)).
% Parameter: \PARAM (loop gain, range 0.0..20.0)
% Range: 0.0 to 20.0, recommended 40 frames
% Difficulty: advanced
% Features demonstrated: control systems, root locus, pole movement, stability

\documentclass[border=8pt,tikz]{standalone}
\usepackage{tikz}
\usepackage{amsmath}
\usetikzlibrary{arrows.meta, calc}

% USC Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}[>=Stealth, every node/.style={font=\small}]

\pgfmathsetmacro{\Kval}{\PARAM}

% Axes
\draw[->, thick] (-5.5, 0) -- (1.5, 0) node[right] {$\mathrm{Re}$};
\draw[->, thick] (0, -4.5) -- (0, 4.5) node[above] {$\mathrm{Im}$};

% Grid
\foreach \x in {-5,-4,-3,-2,-1,1} {
    \draw[warmgrey!25] (\x, -4.2) -- (\x, 4.2);
    \node[below, font=\tiny, warmgrey] at (\x, -4.3) {$\x$};
}
\foreach \y in {-4,-3,-2,-1,1,2,3,4} {
    \draw[warmgrey!25] (-5.3, \y) -- (1.3, \y);
}

% Open-loop poles (crosses)
\draw[thick] (-1, -0.12) -- (-1, 0.12);
\draw[thick] (-1.12, 0) -- (-0.88, 0);
\node[below=2mm, font=\footnotesize] at (-1, 0) {$-1$};
\draw[thick] (-3, -0.12) -- (-3, 0.12);
\draw[thick] (-3.12, 0) -- (-2.88, 0);
\node[below=2mm, font=\footnotesize] at (-3, 0) {$-3$};

% Characteristic equation: s^2 + 4s + 3 + K = 0
% s = -2 +/- sqrt(1 - K)

% Real-axis segment (K=0 to K=1)
\pgfmathparse{\Kval > 0.01 ? 1 : 0}
\ifnum\pgfmathresult=1
    \pgfmathparse{min(\Kval, 1.0)}
    \pgfmathsetmacro{\Kclamp}{\pgfmathresult}
    \pgfmathsetmacro{\realSpread}{sqrt(1 - \Kclamp)}
    \draw[atlantic, thick] (-1, 0) -- ({-2 + \realSpread}, 0);
    \draw[atlantic, thick] (-3, 0) -- ({-2 - \realSpread}, 0);
\fi

% Imaginary branches (K > 1)
\pgfmathparse{\Kval > 1.01 ? 1 : 0}
\ifnum\pgfmathresult=1
    \pgfmathsetmacro{\imMax}{sqrt(\Kval - 1)}
    \draw[garnet, thick, samples=60, domain=0:\imMax, variable=\y]
        plot ({-2}, {\y});
    \draw[garnet, thick, samples=60, domain=0:\imMax, variable=\y]
        plot ({-2}, {-\y});
\fi

% Current pole positions
\pgfmathparse{\Kval <= 1.0 ? 1 : 0}
\ifnum\pgfmathresult=1
    \pgfmathsetmacro{\poleA}{-2 + sqrt(max(1 - \Kval, 0))}
    \pgfmathsetmacro{\poleB}{-2 - sqrt(max(1 - \Kval, 0))}
    \filldraw[garnet] (\poleA, 0) circle (3pt);
    \filldraw[garnet] (\poleB, 0) circle (3pt);
\fi
\pgfmathparse{\Kval > 1.0 ? 1 : 0}
\ifnum\pgfmathresult=1
    \pgfmathsetmacro{\imPart}{sqrt(\Kval - 1)}
    \filldraw[garnet] (-2, \imPart) circle (3pt);
    \filldraw[garnet] (-2, -\imPart) circle (3pt);
    \draw[dashed, thin, warmgrey] (-2, \imPart) -- (-2, 0);
    \draw[dashed, thin, warmgrey] (-2, -\imPart) -- (-2, 0);
\fi

% Label
\node[anchor=north west, font=\normalsize, fill=white, inner sep=3pt,
      draw=warmgrey!50]
    at (-5.3, 4.3)
    {$K = \pgfmathprintnumber[fixed, precision=1]{\Kval}$};

\node[anchor=south west, font=\footnotesize, text=warmgrey!70!black]
    at (-5.3, -4.3)
    {$G(s) = \dfrac{1}{(s+1)(s+3)}$};

\end{tikzpicture}
\end{document}
