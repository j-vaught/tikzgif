% Example 08: Spring-Mass-Damper Step Response Comparison
% Three SMD systems side by side: underdamped, critically damped, overdamped.
% Each column has a physical diagram (top) and progressive response plot (bottom).
% Parameter: \PARAM (time in seconds, 0 to 4)
% Range: 0 to 4, recommended 60 frames at 30fps
% Difficulty: advanced
% Features demonstrated: mechanical diagrams, decorations, pgfplots, step response
\documentclass[tikz]{standalone}
\usepackage{pgfplots}
\usepackage{amsmath}
\pgfplotsset{compat=1.18}
\usetikzlibrary{decorations.pathmorphing, decorations.markings, calc}

% Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}

\useasboundingbox (-0.8, -3.6) rectangle (15.2, 4.2);

% ── Global time parameter ──
\pgfmathsetmacro{\tNow}{\PARAM}
\pgfmathsetmacro{\wn}{5}

% Precompute clamped time for domain endpoint (min of tNow and 4, but at least 0.01)
\pgfmathsetmacro{\tEnd}{max(min(\tNow, 4), 0.01)}
% Clamp for dot position
\pgfmathsetmacro{\tDot}{min(\tNow, 4)}

% ── System parameters ──
% System 1: Underdamped  (zeta=0.2)
\pgfmathsetmacro{\zetaA}{0.2}
\pgfmathsetmacro{\wdA}{\wn * sqrt(1 - \zetaA*\zetaA)}
\pgfmathsetmacro{\phiA}{acos(\zetaA)}

% System 2: Critically damped (zeta=1.0)
\pgfmathsetmacro{\zetaB}{1.0}

% System 3: Overdamped (zeta=2.0)
\pgfmathsetmacro{\zetaC}{2.0}
\pgfmathsetmacro{\sqrtC}{sqrt(\zetaC*\zetaC - 1)}
\pgfmathsetmacro{\sOneC}{-\zetaC*\wn + \wn*\sqrtC}
\pgfmathsetmacro{\sTwoC}{-\zetaC*\wn - \wn*\sqrtC}

% ── Compute current displacements (y = step response value) ──
% Underdamped
\pgfmathsetmacro{\yA}{%
  \tNow < 0.001 ? 0 :
  1 - (exp(-\zetaA*\wn*\tNow) / sqrt(1 - \zetaA*\zetaA))
    * sin(\wdA*\tNow * 180/3.14159 + \phiA)}

% Critically damped
\pgfmathsetmacro{\yB}{%
  \tNow < 0.001 ? 0 :
  1 - (1 + \wn*\tNow) * exp(-\wn*\tNow)}

% Overdamped
\pgfmathsetmacro{\yC}{%
  \tNow < 0.001 ? 0 :
  1 - (\sTwoC * exp(\sOneC*\tNow) - \sOneC * exp(\sTwoC*\tNow))
    / (\sTwoC - \sOneC)}

% ── Column positions ──
\def\colAx{0.5}
\def\colBx{5.5}
\def\colCx{10.5}
\def\plotAx{1.4}
\def\plotBx{6.4}
\def\plotCx{11.4}
\pgfmathsetmacro{\colW}{4.2}

% ── Diagram scale: 1 unit of y(t) = 1.2cm displacement ──
\pgfmathsetmacro{\dispScale}{1.2}

% ════════════════════════════════════════════════════════════════
%  MACRO: Draw one spring-mass-damper diagram
%  #1 = x-offset, #2 = color, #3 = y(t) value, #4 = label,
%  #5 = params text, #6 = yMax (for piston interpolation)
% ════════════════════════════════════════════════════════════════
\newcommand{\drawSMD}[6]{%
  \begin{scope}[shift={(#1, 0)}]
    % Column label
    \node[font=\bfseries\small, #2] at (2.1, 4.0) {#4};
    \node[font=\scriptsize, warmgrey] at (2.1, 3.55) {#5};

    % Coordinates
    \pgfmathsetmacro{\wallX}{0.0}
    \pgfmathsetmacro{\eqX}{2.4}
    \pgfmathsetmacro{\massDisp}{#3 * \dispScale}
    \pgfmathsetmacro{\massX}{\eqX + \massDisp}
    \pgfmathsetmacro{\massW}{0.6}
    \pgfmathsetmacro{\massH}{1.2}
    \pgfmathsetmacro{\massCY}{2.2}

    % Heights for spring and damper
    \pgfmathsetmacro{\springY}{\massCY + 0.35}
    \pgfmathsetmacro{\damperY}{\massCY - 0.35}

    % Mass left edge
    \pgfmathsetmacro{\massLeft}{\massX - \massW/2}

    % ── Wall (hatched) ──
    \draw[very thick, black!80] (\wallX, 1.2) -- (\wallX, 3.2);
    \foreach \yy in {1.3, 1.6, 1.9, 2.2, 2.5, 2.8, 3.1} {
      \draw[thin, warmgrey] (\wallX, \yy) -- ({\wallX - 0.25}, {\yy + 0.2});
    }

    % ── Spring (zigzag from wall to mass) ──
    \pgfmathsetmacro{\springLen}{\massLeft - \wallX}
    \pgfmathsetmacro{\segLen}{max(\springLen/6*28.3465, 4)}
    \draw[thick, black!70, decorate, decoration={zigzag, segment length=\segLen pt, amplitude=2.5pt}]
      (\wallX, \springY) -- (\massLeft, \springY);

    % ── Damper (proper dashpot with cylinder and piston) ──
    \pgfmathsetmacro{\cylW}{0.6}
    \pgfmathsetmacro{\cylH}{0.15}
    \pgfmathsetmacro{\rodLen}{0.45}
    \pgfmathsetmacro{\margin}{0.04}

    % Cylinder position (fixed to wall side)
    \pgfmathsetmacro{\cylLeft}{\wallX + \rodLen}
    \pgfmathsetmacro{\cylRight}{\cylLeft + \cylW}

    % Rod from wall to cylinder closed end
    \draw[thick, black!70] (\wallX, \damperY) -- (\cylLeft, \damperY);

    % Cylinder body (closed on left, open on right)
    \draw[thick, black!70]
      (\cylLeft, {\damperY - \cylH}) -- (\cylLeft, {\damperY + \cylH})
      (\cylLeft, {\damperY + \cylH}) -- (\cylRight, {\damperY + \cylH})
      (\cylLeft, {\damperY - \cylH}) -- (\cylRight, {\damperY - \cylH});

    % Piston head position: interpolates inside cylinder based on y/yMax
    \pgfmathsetmacro{\pistonFrac}{#3 / #6}
    \pgfmathsetmacro{\pistonX}{\cylLeft + \margin + \pistonFrac * (\cylW - 2*\margin)}

    % Piston head (vertical bar inside cylinder)
    \draw[very thick, black!80]
      (\pistonX, {\damperY - \cylH + 0.02}) -- (\pistonX, {\damperY + \cylH - 0.02});

    % Piston rod from piston head to mass
    \draw[thick, black!70] (\pistonX, \damperY) -- (\massLeft, \damperY);

    % ── Mass block ──
    \fill[#2, opacity=0.85]
      (\massLeft, {\massCY - \massH/2})
      rectangle
      ({\massX + \massW/2}, {\massCY + \massH/2});
    \draw[thick, black!80]
      (\massLeft, {\massCY - \massH/2})
      rectangle
      ({\massX + \massW/2}, {\massCY + \massH/2});
    \node[font=\bfseries\scriptsize, white] at (\massX, \massCY) {$m$};

    % ── Spring/damper labels ──
    \node[font=\tiny, black!60, above] at ({(\wallX + \massLeft)/2}, {\springY + 0.1}) {$k$};
    \node[font=\tiny, black!60, below] at ({(\cylLeft + \cylRight)/2}, {\damperY - \cylH - 0.05}) {$c$};
  \end{scope}
}%

% ═══ Draw the three SMD diagrams ═══
\drawSMD{\colAx}{garnet}{\yA}{Underdamped}{$k\!=\!25,\; m\!=\!1,\; c\!=\!2$}{1.53}
\drawSMD{\colBx}{atlantic}{\yB}{Critically Damped}{$k\!=\!25,\; m\!=\!1,\; c\!=\!10$}{1.0}
\drawSMD{\colCx}{congaree}{\yC}{Overdamped}{$k\!=\!25,\; m\!=\!1,\; c\!=\!20$}{1.0}

% ════════════════════════════════════════════════════════════════
%  BOTTOM ROW: Response plots
% ════════════════════════════════════════════════════════════════

% ── Plot 1: Underdamped ──
\begin{axis}[
  at={(\plotAx cm, -2.4cm)}, anchor=south west,
  width=4.8cm, height=4.0cm,
  xmin=0, xmax=4, ymin=-0.05, ymax=1.65,
  xtick={0,1,2,3,4}, ytick={0,0.5,1.0,1.5},
  tick label style={font=\tiny},
  xlabel={$t$ (s)}, ylabel={$y(t)$},
  label style={font=\tiny},
  grid=major, grid style={warmgrey!20},
  axis line style={thin},
  clip=true,
]
  % Setpoint
  \addplot[dashed, warmgrey, thin, domain=0:4, samples=2] {1};
  % Ghost (full curve)
  \addplot[garnet, opacity=0.15, thin, domain=0:4, samples=200]
    {1 - (exp(-\zetaA*\wn*x) / sqrt(1 - \zetaA*\zetaA))
      * sin(\wdA*x*180/3.14159 + \phiA)};
  % Active trace up to tNow
  \addplot[garnet, very thick, domain=0:\tEnd, samples=200]
    {1 - (exp(-\zetaA*\wn*x) / sqrt(1 - \zetaA*\zetaA))
      * sin(\wdA*x*180/3.14159 + \phiA)};
  % Current dot
  \pgfmathparse{\tNow > 0.01 ? 1 : 0}
  \ifnum\pgfmathresult=1
    \addplot[only marks, mark=*, mark size=2pt, garnet]
      coordinates {(\tDot, \yA)};
  \fi
\end{axis}

% ── Plot 2: Critically Damped ──
\begin{axis}[
  at={(\plotBx cm, -2.4cm)}, anchor=south west,
  width=4.8cm, height=4.0cm,
  xmin=0, xmax=4, ymin=-0.05, ymax=1.65,
  xtick={0,1,2,3,4}, ytick={0,0.5,1.0,1.5},
  tick label style={font=\tiny},
  xlabel={$t$ (s)}, ylabel={$y(t)$},
  label style={font=\tiny},
  grid=major, grid style={warmgrey!20},
  axis line style={thin},
  clip=true,
]
  % Setpoint
  \addplot[dashed, warmgrey, thin, domain=0:4, samples=2] {1};
  % Ghost
  \addplot[atlantic, opacity=0.15, thin, domain=0:4, samples=200]
    {1 - (1 + \wn*x) * exp(-\wn*x)};
  % Active trace
  \addplot[atlantic, very thick, domain=0:\tEnd, samples=200]
    {1 - (1 + \wn*x) * exp(-\wn*x)};
  % Current dot
  \pgfmathparse{\tNow > 0.01 ? 1 : 0}
  \ifnum\pgfmathresult=1
    \addplot[only marks, mark=*, mark size=2pt, atlantic]
      coordinates {(\tDot, \yB)};
  \fi
\end{axis}

% ── Plot 3: Overdamped ──
\begin{axis}[
  at={(\plotCx cm, -2.4cm)}, anchor=south west,
  width=4.8cm, height=4.0cm,
  xmin=0, xmax=4, ymin=-0.05, ymax=1.65,
  xtick={0,1,2,3,4}, ytick={0,0.5,1.0,1.5},
  tick label style={font=\tiny},
  xlabel={$t$ (s)}, ylabel={$y(t)$},
  label style={font=\tiny},
  grid=major, grid style={warmgrey!20},
  axis line style={thin},
  clip=true,
]
  % Setpoint
  \addplot[dashed, warmgrey, thin, domain=0:4, samples=2] {1};
  % Ghost
  \addplot[congaree, opacity=0.15, thin, domain=0:4, samples=200]
    {1 - (\sTwoC * exp(\sOneC*x) - \sOneC * exp(\sTwoC*x)) / (\sTwoC - \sOneC)};
  % Active trace
  \addplot[congaree, very thick, domain=0:\tEnd, samples=200]
    {1 - (\sTwoC * exp(\sOneC*x) - \sOneC * exp(\sTwoC*x)) / (\sTwoC - \sOneC)};
  % Current dot
  \pgfmathparse{\tNow > 0.01 ? 1 : 0}
  \ifnum\pgfmathresult=1
    \addplot[only marks, mark=*, mark size=2pt, congaree]
      coordinates {(\tDot, \yC)};
  \fi
\end{axis}

% ── Vertical separator lines between columns ──
\draw[warmgrey!40, thin] (5.25, -3.6) -- (5.25, 4.2);
\draw[warmgrey!40, thin] (10.25, -3.6) -- (10.25, 4.2);

% ── Time display (bottom right) ──
\node[font=\footnotesize, anchor=east, warmgrey] at (15.0, -3.25)
  {$t = \pgfmathprintnumber[fixed, precision=2]{\tNow}$ s};

\end{tikzpicture}
\end{document}
