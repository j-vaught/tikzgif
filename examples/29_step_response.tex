% Example 29: Second-Order Step Response
% Animates unit step response as damping ratio sweeps from underdamped to overdamped.
% Parameter: \PARAM (damping ratio, range 0.1..2.0)
% Range: 0.1 to 2.0, recommended 39 frames
% Difficulty: intermediate
% Features demonstrated: control systems, step response, damping effects

\documentclass[border=5pt]{standalone}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{amsmath}
\pgfplotsset{compat=1.18}

% USC Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}

\pgfmathsetmacro{\zeta}{\PARAM}
\pgfmathsetmacro{\wn}{3.0}
\pgfmathsetmacro{\wdamp}{\wn * sqrt(abs(1 - \zeta*\zeta))}
\pgfmathsetmacro{\sigma}{\zeta * \wn}

\begin{axis}[
    width=10cm, height=6.5cm,
    xmin=0, xmax=5, ymin=0, ymax=2.0,
    xlabel={Time $t$ (s)},
    ylabel={$y(t)$},
    title={Step Response: $\zeta = \pgfmathprintnumber[fixed, precision=2]{\zeta}$,\;
           $\omega_n = \pgfmathprintnumber[fixed, precision=1]{\wn}$ rad/s},
    grid=major, grid style={warmgrey!30}, thick,
    every axis title/.style={font=\normalsize},
    legend pos=south east,
    legend style={font=\footnotesize},
]
    % Reference line
    \addplot[domain=0:5, samples=2, dashed, black!50, thin] {1};

    % Underdamped case (zeta < 1)
    \pgfmathparse{\zeta < 0.999 ? 1 : 0}
    \ifnum\pgfmathresult=1
        \pgfmathsetmacro{\phirad}{acos(\zeta)}
        \addplot[domain=0:5, samples=200, atlantic, very thick]
            {1 - (exp(-\sigma * x) / sqrt(1 - \zeta*\zeta))
             * sin(\wdamp * x * 180/3.14159 + \phirad)};
        \addlegendentry{Underdamped}
    \fi

    % Critically damped (zeta = 1)
    \pgfmathparse{(\zeta >= 0.999) && (\zeta <= 1.001) ? 1 : 0}
    \ifnum\pgfmathresult=1
        \addplot[domain=0:5, samples=200, garnet, very thick]
            {1 - (1 + \wn*x) * exp(-\wn * x)};
        \addlegendentry{Critically damped}
    \fi

    % Overdamped (zeta > 1)
    \pgfmathparse{\zeta > 1.001 ? 1 : 0}
    \ifnum\pgfmathresult=1
        \pgfmathsetmacro{\sqrtterm}{sqrt(\zeta*\zeta - 1)}
        \pgfmathsetmacro{\sone}{-\zeta*\wn + \wn*\sqrtterm}
        \pgfmathsetmacro{\stwo}{-\zeta*\wn - \wn*\sqrtterm}
        \pgfmathsetmacro{\coeffA}{\stwo / (\stwo - \sone)}
        \pgfmathsetmacro{\coeffB}{\sone / (\sone - \stwo)}
        \addplot[domain=0:5, samples=200, horseshoe, very thick]
            {1 + \coeffA * exp(\sone * x) + \coeffB * exp(\stwo * x)};
        \addlegendentry{Overdamped}
    \fi

    % Overshoot annotation (underdamped only)
    \pgfmathparse{\zeta < 0.999 ? 1 : 0}
    \ifnum\pgfmathresult=1
        \pgfmathsetmacro{\Mp}{exp(-3.14159*\zeta / sqrt(1-\zeta*\zeta))}
        \pgfmathsetmacro{\tp}{3.14159 / \wdamp}
        \pgfmathsetmacro{\yp}{1 + \Mp}
        \draw[<-, thin, garnet]
            (axis cs:\tp, \yp) -- ++(axis direction cs:0.3,0.15)
            node[right, font=\tiny, text=garnet]
            {$M_p = \pgfmathprintnumber[fixed, precision=1, multiply to=100]{\Mp}\%$};
    \fi
\end{axis}

\end{tikzpicture}
\end{document}
