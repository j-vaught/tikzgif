% Example 18: Feedback Block Diagram with Gain Sweep
% Negative-feedback control loop showing gain impact on step response.
% Parameter: \PARAM (proportional gain K, range 0.1..10.0)
% Range: 0.1 to 10.0, recommended 30 frames
% Difficulty: intermediate
% Features demonstrated: block diagrams, feedback control, step response

\documentclass[border=5pt,tikz]{standalone}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{amsmath}
\usetikzlibrary{arrows.meta, positioning, calc}
\pgfplotsset{compat=1.18}

% USC Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}[
    block/.style={draw, thick, minimum height=1cm, minimum width=1.4cm,
                  fill=white},
    sumnode/.style={draw, thick, circle, minimum size=6mm, inner sep=0pt},
    >=Stealth,
    every node/.style={font=\small}
]

\pgfmathsetmacro{\K}{\PARAM}

% Block diagram
\node[sumnode] (sum) at (0,0) {};
\node[below left=0.5mm] at (sum.center) {\tiny $+$};
\node[above left=0.5mm and -1mm] at (sum.south) {\tiny $-$};

\node[block, right=1.2cm of sum, fill=atlantic!8] (gain)
    {$K = \pgfmathprintnumber[fixed, precision=2]{\K}$};
\node[block, right=1.2cm of gain, fill=garnet!8] (plant)
    {$\dfrac{1}{s+1}$};

\coordinate (output) at ($(plant.east) + (1.5,0)$);

% Arrows
\draw[->] ($(sum.west) + (-1.2, 0)$) -- node[above]{$R(s)$} (sum.west);
\draw[->] (sum.east) -- (gain.west);
\draw[->] (gain.east) -- (plant.west);
\draw[->] (plant.east) -- node[above]{$Y(s)$} (output);
\draw[-] ($(plant.east) + (1.0, 0)$) -- ++(0, -1.5);
\draw[->] ($(plant.east) + (1.0, -1.5)$) -| (sum.south);
\filldraw ($(plant.east) + (1.0, 0)$) circle (1.5pt);

% Step response plot
% Closed-loop: Y/R = K/(s + 1 + K), step = K/(1+K) * (1 - e^{-(1+K)t})
\begin{axis}[
    at={(6.2cm, -1.6cm)},
    anchor=south west,
    width=5.5cm, height=4cm,
    xmin=0, xmax=5, ymin=0, ymax=1.15,
    xlabel={$t$ (s)},
    ylabel={$y(t)$},
    title={\footnotesize Step Response},
    grid=major,
    grid style={warmgrey!30},
    thick,
    every axis title/.style={font=\footnotesize},
    tick label style={font=\tiny},
    label style={font=\footnotesize},
]
    \pgfmathsetmacro{\KK}{\PARAM}
    \pgfmathsetmacro{\dc}{\KK / (1 + \KK)}
    \pgfmathsetmacro{\tau}{1 + \KK}
    \addplot[domain=0:5, samples=100, atlantic, very thick]
        {\dc * (1 - exp(-\tau * x))};
    \addplot[domain=0:5, dashed, garnet, thin] {\dc};
    \node[anchor=south east, font=\tiny, text=garnet]
        at (axis cs:5, \dc)
        {$y_{\mathrm{ss}} = \pgfmathprintnumber[fixed, precision=3]{\dc}$};
\end{axis}

\end{tikzpicture}
\end{document}
