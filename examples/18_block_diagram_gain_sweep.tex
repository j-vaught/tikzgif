% Example 18: Feedback Block Diagram with Gain Sweep
% Negative-feedback control loop with 2nd-order plant showing gain impact.
% Parameter: \PARAM (proportional gain K, range 0.1..10.0)
% Range: 0.1 to 10.0, recommended 30 frames
% Difficulty: intermediate
% Features demonstrated: block diagrams, feedback control, 2nd-order response,
%   overshoot markers, settling band, error signal, color-coded gain

\documentclass[border=5pt,tikz]{standalone}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage{amsmath}
\usetikzlibrary{arrows.meta, positioning, calc}
\pgfplotsset{compat=1.18}
\usepgfplotslibrary{fillbetween}

% USC Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}[
    block/.style={draw, thick, minimum height=1cm, minimum width=1.4cm,
                  fill=white},
    sumnode/.style={draw, thick, circle, minimum size=6mm, inner sep=0pt},
    >=Stealth,
    every node/.style={font=\small}
]

\pgfmathsetmacro{\K}{\PARAM}

% 2nd-order plant: G(s) = 1/(s(s+1)), closed-loop: K/(s^2+s+K)
% wn = sqrt(K), zeta = 1/(2*sqrt(K))
\pgfmathsetmacro{\wn}{sqrt(max(\K, 0.01))}
\pgfmathsetmacro{\zetaRaw}{1.0 / (2.0 * \wn)}
\pgfmathsetmacro{\zetaC}{min(\zetaRaw, 5.0)}
\pgfmathsetmacro{\sigma}{\zetaC * \wn}
\pgfmathsetmacro{\wdSq}{max(\wn*\wn - \sigma*\sigma, 0.001)}
\pgfmathsetmacro{\wdamp}{sqrt(\wdSq)}

% Gain fill intensity: 0% at K=0.1, 60% at K=10
\pgfmathtruncatemacro{\fillpct}{min(round(6 * \K), 60)}
\pgfmathtruncatemacro{\isunder}{\zetaC < 0.999 ? 1 : 0}
\pgfmathsetmacro{\Mp}{\isunder > 0 ? exp(-3.14159*\zetaC / sqrt(max(1-\zetaC*\zetaC,0.001))) : 0}

% Gauge needle value: peak step response
\pgfmathsetmacro{\needleVal}{1 + \Mp}
\pgfmathsetmacro{\needleAngle}{180 * (1 - min(\needleVal, 1.8) / 1.8)}

% ---- BLOCK DIAGRAM (top) ----
\node[sumnode] (sum) at (0,3.5) {};
\node[below left=0.5mm] at (sum.center) {\tiny $+$};
\node[above left=0.5mm and -1mm] at (sum.south) {\tiny $-$};

\node[block, right=1.2cm of sum, fill=atlantic!\fillpct] (gain)
    {$K = \pgfmathprintnumber[fixed, precision=2]{\K}$};
\node[block, right=1.2cm of gain, fill=garnet!8] (plant)
    {$\dfrac{1}{s(s\!+\!1)}$};

\coordinate (output) at ($(plant.east) + (1.5,0)$);

% Arrows
\draw[->] ($(sum.west) + (-1.2, 0)$) -- node[above]{$R(s)$} (sum.west);
\draw[->] (sum.east) -- node[above, font=\tiny]{$E$} (gain.west);
\draw[->] (gain.east) -- (plant.west);
\draw[->] (plant.east) -- node[above]{$Y(s)$} (output);
\draw[-] ($(plant.east) + (1.0, 0)$) -- ++(0, -1.0);
\draw[->] ($(plant.east) + (1.0, -1.0)$) -| (sum.south);
\filldraw ($(plant.east) + (1.0, 0)$) circle (1.5pt);

% Connection arrow to gauge
\draw[->, warmgrey, thick] (output) -- (10.0, 3.0);

% System info
\node[font=\tiny, warmgrey, anchor=west] at ($(sum.west)+(-1.2,-0.5)$)
    {$\zeta = \pgfmathprintnumber[fixed,precision=2]{\zetaC}$,\;
     $\omega_n = \pgfmathprintnumber[fixed,precision=2]{\wn}$};

% ---- GAUGE / SPEEDOMETER ----
\begin{scope}[shift={(10.0, 3.0)}]
    % Color bands (arc segments)
    % warmgrey!30: y=0..0.9 (angles 180..90)
    \draw[warmgrey!30, line width=2.5mm]
        ({1.8*cos(180)},{1.8*sin(180)}) arc (180:90:1.8);
    % horseshoe!50: y=0.9..1.1 (angles 90..70)
    \draw[horseshoe!50, line width=2.5mm]
        ({1.8*cos(90)},{1.8*sin(90)}) arc (90:70:1.8);
    % honeycomb!50: y=1.1..1.4 (angles 70..40)
    \draw[honeycomb!50, line width=2.5mm]
        ({1.8*cos(70)},{1.8*sin(70)}) arc (70:40:1.8);
    % rose!50: y=1.4..1.8 (angles 40..0)
    \draw[rose!50, line width=2.5mm]
        ({1.8*cos(40)},{1.8*sin(40)}) arc (40:0:1.8);

    % Outer arc
    \draw[black!70, thick] ({1.8*cos(180)},{1.8*sin(180)}) arc (180:0:1.8);

    % Baseline
    \draw[black!30, thin] (-1.8, 0) -- (1.8, 0);

    % Setpoint marker at y=1.0 (angle 80)
    \draw[atlantic, dashed, thin] (0,0) -- ({1.17*cos(80)},{1.17*sin(80)});
    \fill[atlantic] ({1.65*cos(80)},{1.65*sin(80)})
        -- ({1.95*cos(83)},{1.95*sin(83)})
        -- ({1.95*cos(77)},{1.95*sin(77)}) -- cycle;
    \node[font=\tiny, atlantic] at ({1.35*cos(80)+0.15},{1.35*sin(80)+0.1}) {SP};

    % Major ticks with labels: 0, 0.5, 1.0, 1.5
    \foreach \val/\ang in {0/180, 0.5/130, 1.0/80, 1.5/30} {
        \draw[black!70, thick]
            ({1.65*cos(\ang)},{1.65*sin(\ang)}) -- ({1.95*cos(\ang)},{1.95*sin(\ang)});
        \node[font=\tiny, black!70] at ({1.45*cos(\ang)},{1.45*sin(\ang)})
            {\pgfmathprintnumber[fixed,precision=1]{\val}};
    }

    % Minor ticks at 0.1 increments
    \foreach \v in {0.1,0.2,0.3,0.4,0.6,0.7,0.8,0.9,1.1,1.2,1.3,1.4,1.6,1.7} {
        \pgfmathsetmacro{\mang}{180*(1-\v/1.8)}
        \draw[black!40, thin]
            ({1.72*cos(\mang)},{1.72*sin(\mang)}) -- ({1.88*cos(\mang)},{1.88*sin(\mang)});
    }

    % Needle (garnet triangle)
    \fill[garnet] (0,0)
        -- ({1.65*cos(\needleAngle+1.5)},{1.65*sin(\needleAngle+1.5)})
        -- ({1.65*cos(\needleAngle-1.5)},{1.65*sin(\needleAngle-1.5)})
        -- cycle;

    % Hub
    \fill[black!80] (0,0) circle (2.5pt);

    % Title
    \node[font=\footnotesize, black, anchor=south] at (0, 2.15) {\textbf{Output}};

    % Digital readout
    \node[font=\tiny, garnet, anchor=north] at (0, -0.2)
        {$y_{\mathrm{peak}} = \pgfmathprintnumber[fixed,precision=2]{\needleVal}$};
\end{scope}

% ---- STEP RESPONSE (bottom, larger) ----
\begin{axis}[
    name=stepax,
    at={(0cm, -0.5cm)}, anchor=north west,
    width=12.5cm, height=5.5cm,
    xmin=0, xmax=8, ymin=-0.15, ymax=1.8,
    xlabel={$t$ (s)}, ylabel={$y(t)$},
    title={\footnotesize Step Response},
    grid=major, grid style={warmgrey!20}, thick,
    every axis title/.style={font=\footnotesize},
    tick label style={font=\tiny},
    label style={font=\footnotesize},
    clip=false,
]
    % 2% settling band
    \addplot[domain=0:8, samples=2, name path=upper, draw=none] {1.02};
    \addplot[domain=0:8, samples=2, name path=lower, draw=none] {0.98};
    \addplot[fill=sandstorm, fill opacity=0.4] fill between[of=upper and lower];
    \addplot[domain=0:8, samples=2, dashed, warmgrey!50, very thin] {1.02};
    \addplot[domain=0:8, samples=2, dashed, warmgrey!50, very thin] {0.98};

    % Reference
    \addplot[domain=0:8, samples=2, dashed, black!40, thin] {1};

    % Step response
    \ifnum\isunder>0
        \pgfmathsetmacro{\phiDeg}{acos(min(\zetaC,0.999))}
        % Main response
        \addplot[domain=0:8, samples=300, atlantic, very thick]
            {1 - exp(-\sigma * x) / sqrt(max(1-\zetaC*\zetaC,0.001))
             * sin(\wdamp * x * 180/3.14159 + \phiDeg)};
        % Error signal
        \addplot[domain=0:8, samples=200, rose, thin]
            {exp(-\sigma * x) / sqrt(max(1-\zetaC*\zetaC,0.001))
             * sin(\wdamp * x * 180/3.14159 + \phiDeg)};
        \node[font=\tiny, rose] at (axis cs:1.0, 0.6) {$e(t)$};
    \fi

    % Critically damped
    \pgfmathparse{(\zetaC >= 0.999) && (\zetaC <= 1.001) ? 1 : 0}
    \ifnum\pgfmathresult=1
        \addplot[domain=0:8, samples=300, garnet, very thick]
            {1 - (1 + \wn*x) * exp(-\wn*x)};
    \fi

    % Overdamped
    \pgfmathparse{\zetaC > 1.001 ? 1 : 0}
    \ifnum\pgfmathresult=1
        \pgfmathsetmacro{\sqZ}{sqrt(\zetaC*\zetaC - 1)}
        \pgfmathsetmacro{\sA}{(-\zetaC + \sqZ)*\wn}
        \pgfmathsetmacro{\sB}{(-\zetaC - \sqZ)*\wn}
        \pgfmathsetmacro{\cA}{\sB / (\sA - \sB)}
        \pgfmathsetmacro{\cB}{\sA / (\sB - \sA)}
        \addplot[domain=0:8, samples=300, horseshoe, very thick]
            {1 + \cA * exp(\sA * x) + \cB * exp(\sB * x)};
    \fi

    % Overshoot marker (underdamped)
    \ifnum\isunder>0
        \pgfmathsetmacro{\tpeak}{3.14159 / \wdamp}
        \pgfmathsetmacro{\tpC}{min(\tpeak, 7.5)}
        \pgfmathsetmacro{\MpPctV}{\Mp * 100}
        % Horizontal Mp line
        \addplot[dashed, garnet, very thin] coordinates {(0, {1+\Mp}) (\tpC, {1+\Mp})};
        \draw[<->, garnet, thin]
            (axis cs:{\tpC + 0.3}, 1) -- (axis cs:{\tpC + 0.3}, {1+\Mp});
        \node[font=\tiny, garnet, anchor=west]
            at (axis cs:{\tpC + 0.4}, {1 + \Mp*0.5})
            {$\pgfmathprintnumber[fixed,precision=0]{\MpPctV}\%$};
    \fi
\end{axis}

\end{tikzpicture}
\end{document}
