% Example 25: Phase Portrait Animation
% Phase portrait of dx/dt = [[-a, b], [-b, -a]]*x showing stable spiral to unstable spiral.
% Parameter: \PARAM (real part of eigenvalue a, range -1.0..2.0)
% Range: -1.0 to 2.0, recommended 30 frames
% Difficulty: advanced
% Features demonstrated: phase portrait, ODE, dynamical systems, spiral stability
\documentclass[border=8pt,tikz]{standalone}
\usepackage{tikz}
\usepackage{amsmath}
\usetikzlibrary{arrows.meta}

% USC Brand Colors
\definecolor{garnet}{HTML}{73000A}
\definecolor{rose}{HTML}{CC2E40}
\definecolor{atlantic}{HTML}{466A9F}
\definecolor{congaree}{HTML}{1F414D}
\definecolor{horseshoe}{HTML}{65780B}
\definecolor{grass}{HTML}{CED318}
\definecolor{honeycomb}{HTML}{A49137}
\definecolor{warmgrey}{HTML}{676156}
\definecolor{sandstorm}{HTML}{FFF2E3}

\begin{document}
\begin{tikzpicture}[>=Stealth]

\pgfmathsetmacro{\aval}{\PARAM}
\pgfmathsetmacro{\bval}{2.0}

% Axes
\draw[->, thick, black!60] (-4.2, 0) -- (4.2, 0) node[right, font=\small]{$x_1$};
\draw[->, thick, black!60] (0, -4.2) -- (0, 4.2) node[above, font=\small]{$x_2$};

% Grid
\foreach \v in {-4,-3,-2,-1,1,2,3,4} {
    \draw[warmgrey!15, thin] (\v, -4) -- (\v, 4);
    \draw[warmgrey!15, thin] (-4, \v) -- (4, \v);
}

% Vector field
\foreach \xi in {-3.5, -2.5, -1.5, -0.5, 0.5, 1.5, 2.5, 3.5} {
    \foreach \yi in {-3.5, -2.5, -1.5, -0.5, 0.5, 1.5, 2.5, 3.5} {
        \pgfmathsetmacro{\dx}{-\aval*\xi + \bval*\yi}
        \pgfmathsetmacro{\dy}{-\bval*\xi - \aval*\yi}
        \pgfmathsetmacro{\mag}{sqrt(\dx*\dx + \dy*\dy)}
        \pgfmathsetmacro{\scale}{min(0.35, 0.35*\mag/3)}
        \pgfmathparse{\mag > 0.1 ? 1 : 0}
        \ifnum\pgfmathresult=1
            \pgfmathsetmacro{\ndx}{\dx/\mag*\scale}
            \pgfmathsetmacro{\ndy}{\dy/\mag*\scale}
            \draw[->, warmgrey!50, thin] (\xi, \yi) -- ({\xi+\ndx}, {\yi+\ndy});
        \fi
    }
}

% Trajectories: x(t) = e^{-a*t} * R0 * [cos(b*t + th), sin(b*t + th)]
\foreach \thetaStart in {0, 60, 120, 180, 240, 300} {
    \pgfmathsetmacro{\R}{3.0}
    \draw[atlantic, thick, samples=120, domain=0:6.28, variable=\t]
        plot ({exp(-\aval*\t) * \R * cos(\bval*\t*180/3.14159 + \thetaStart)},
              {exp(-\aval*\t) * \R * sin(\bval*\t*180/3.14159 + \thetaStart)});
    \filldraw[garnet]
        ({\R * cos(\thetaStart)}, {\R * sin(\thetaStart)}) circle (2pt);
}

\filldraw[black] (0, 0) circle (3pt);

% Stability label
\pgfmathparse{\aval > 0.05 ? 1 : (\aval < -0.05 ? -1 : 0)}
\pgfmathtruncatemacro{\stabType}{\pgfmathresult}

\ifnum\stabType=1
    \node[anchor=north east, font=\footnotesize, fill=horseshoe!10, inner sep=3pt,
          draw=horseshoe]
        at (4.0, 4.0) {Stable spiral ($a = \pgfmathprintnumber[fixed,precision=2]{\aval}$)};
\fi
\ifnum\stabType=-1
    \node[anchor=north east, font=\footnotesize, fill=garnet!10, inner sep=3pt,
          draw=garnet]
        at (4.0, 4.0) {Unstable spiral ($a = \pgfmathprintnumber[fixed,precision=2]{\aval}$)};
\fi
\ifnum\stabType=0
    \node[anchor=north east, font=\footnotesize, fill=honeycomb!10, inner sep=3pt,
          draw=honeycomb]
        at (4.0, 4.0) {Center ($a \approx 0$)};
\fi

\node[anchor=south west, font=\footnotesize, fill=white, inner sep=3pt]
    at (-4.0, -4.0)
    {$\dot{\mathbf{x}} = \begin{bmatrix} -a & b \\ -b & -a \end{bmatrix} \mathbf{x}$};

\end{tikzpicture}
\end{document}
